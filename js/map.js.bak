// åºƒå³¶çœŒåŒ»ç™‚åœãƒªã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ— - Leafletåœ°å›³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
// å¸‚åŒºç”ºæ‘GeoJSONã‚’APIã‹ã‚‰å–å¾—ã—ã¦åŒ»ç™‚åœã”ã¨ã«è¡¨ç¤º

class HiroshimaMap {
  constructor(containerId) {
    this.containerId = containerId;
    this.map = null;
    this.markers = [];
    this.regionLayers = {};
    this.municipalityLayers = [];
    this.currentRegion = null;

    this.center = [34.45, 132.85];
    this.defaultZoom = 9;

    // å¸‚åŒºç”ºæ‘ã‹ã‚‰åŒ»ç™‚åœã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    this.municipalityToRegion = MEDICAL_DATA.municipalityMapping;

    // å¸‚åŒºç”ºæ‘åãƒªã‚¹ãƒˆï¼ˆGeoJSONå–å¾—ç”¨ï¼‰
    this.municipalities = [
      // åºƒå³¶åœåŸŸ
      "åºƒå³¶å¸‚ä¸­åŒº", "åºƒå³¶å¸‚æ±åŒº", "åºƒå³¶å¸‚å—åŒº", "åºƒå³¶å¸‚è¥¿åŒº",
      "åºƒå³¶å¸‚å®‰ä½å—åŒº", "åºƒå³¶å¸‚å®‰ä½åŒ—åŒº", "åºƒå³¶å¸‚å®‰èŠ¸åŒº", "åºƒå³¶å¸‚ä½ä¼¯åŒº",
      "å®‰èŠ¸é«˜ç”°å¸‚", "åºœä¸­ç”º", "æµ·ç”°ç”º", "ç†Šé‡ç”º", "å‚ç”º", "å®‰èŠ¸å¤ªç”°ç”º", "åŒ—åºƒå³¶ç”º",
      // åºƒå³¶è¥¿åœåŸŸ
      "å¤§ç«¹å¸‚", "å»¿æ—¥å¸‚å¸‚",
      // å‘‰åœåŸŸ
      "å‘‰å¸‚", "æ±Ÿç”°å³¶å¸‚",
      // åºƒå³¶ä¸­å¤®åœåŸŸ
      "æ±åºƒå³¶å¸‚", "ç«¹åŸå¸‚", "å¤§å´ä¸Šå³¶ç”º",
      // å°¾ä¸‰åœåŸŸ
      "ä¸‰åŸå¸‚", "å°¾é“å¸‚", "ä¸–ç¾…ç”º",
      // ç¦å±±ãƒ»åºœä¸­åœåŸŸ
      "ç¦å±±å¸‚", "åºœä¸­å¸‚", "ç¥çŸ³é«˜åŸç”º",
      // å‚™åŒ—åœåŸŸ
      "ä¸‰æ¬¡å¸‚", "åº„åŸå¸‚"
    ];

    this.init();
  }

  async init() {
    // Hiroshima bounds for restriction
    const southWest = L.latLng(33.8, 131.8);
    const northEast = L.latLng(35.2, 133.7);
    const bounds = L.latLngBounds(southWest, northEast);

    // Leafletãƒãƒƒãƒ—åˆæœŸåŒ–
    this.map = L.map(this.containerId, {
      center: this.center,
      zoom: this.defaultZoom,
      zoomControl: true,
      scrollWheelZoom: true,
      maxBounds: bounds,
      maxBoundsViscosity: 1.0,
      minZoom: 9
    });

    // ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 18,
      opacity: 0.8
    }).addTo(this.map);

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    this.showLoading('å¸‚åŒºç”ºæ‘å¢ƒç•Œã‚’èª­ã¿è¾¼ã¿ä¸­...');

    try {
      // å¸‚åŒºç”ºæ‘GeoJSONã‚’å–å¾—
      await this.loadMunicipalityBoundaries();

      // ç—…é™¢ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
      this.addHospitalMarkers();

      // å‡¡ä¾‹è¿½åŠ 
      this.addLegend();

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
      this.hideLoading();

      // åˆæœŸã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«è¡¨ç¤º
      this.updateSidePanel(null);

    } catch (error) {
      console.error('Error initializing map:', error);
      this.hideLoading();
    }
  }

  showLoading(message) {
    const container = document.getElementById(this.containerId);
    if (container) {
      const loading = document.createElement('div');
      loading.id = 'map-loading';
      // Inline styles for loading are fine as they are transient, but updated for light theme
      loading.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;background:rgba(255,255,255,0.95);padding:24px 40px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,0.1);display:flex;align-items:center;gap:16px;font-family:"Noto Sans JP",sans-serif;border:1px solid #e2e8f0;';
      loading.innerHTML = `
        <div style="width:28px;height:28px;border:3px solid #2563EB;border-radius:50%;border-top-color:transparent;animation:spin 1s linear infinite;"></div>
        <span style="font-size:14px;color:#1e293b;font-weight:500;">${message}</span>
        <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
      `;
      container.style.position = 'relative';
      container.appendChild(loading);
    }
  }

  hideLoading() {
    const loading = document.getElementById('map-loading');
    if (loading) loading.remove();
  }

  async loadMunicipalityBoundaries() {
    // uedayou.net APIã‹ã‚‰å¸‚åŒºç”ºæ‘GeoJSONã‚’å–å¾—
    const fetchPromises = this.municipalities.map(async (name) => {
      try {
        // åºœä¸­å¸‚ã¯ã€Œåºƒå³¶çœŒåºœä¸­å¸‚ã€ã¨ã—ã¦å–å¾—ï¼ˆæ±äº¬éƒ½åºœä¸­å¸‚ã¨ã®æ··åŒå›é¿ï¼‰
        const fullName = name === 'åºœä¸­å¸‚' ? 'åºƒå³¶çœŒåºœä¸­å¸‚' : name;
        const encodedName = encodeURIComponent(fullName);
        const url = `https://uedayou.net/loa/${encodedName}.geojson`;

        const response = await fetch(url);
        if (!response.ok) {
          console.warn(`Failed to fetch: ${name}`);
          return null;
        }

        const geojson = await response.json();
        return { name, geojson };
      } catch (error) {
        console.warn(`Error fetching ${name}:`, error.message);
        return null;
      }
    });

    const results = await Promise.all(fetchPromises);

    // å–å¾—æˆåŠŸã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’åœ°å›³ã«è¿½åŠ 
    const successful = results.filter(r => r !== null);
    console.log(`Loaded ${successful.length}/${this.municipalities.length} municipalities`);

    // åŒ»ç™‚åœã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const regionGroups = {};

    successful.forEach(({ name, geojson }) => {
      const regionId = this.municipalityToRegion[name];
      if (!regionId) {
        console.warn(`No region mapping for: ${name}`);
        return;
      }

      if (!regionGroups[regionId]) {
        regionGroups[regionId] = [];
      }

      const region = MEDICAL_DATA.regions[regionId];
      if (!region) return;

      try {
        const layer = L.geoJSON(geojson, {
          style: {
            color: region.color,
            weight: 2,
            opacity: 0.8,
            fillColor: region.color,
            fillOpacity: 0.2 // Reduced opacity for cleaner look
          },
          onEachFeature: (feature, layer) => {
            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
            layer.bindTooltip(`<strong>${name}</strong><br><span style="color:${region.color}">${region.name}åŒ»ç™‚åœ</span>`, {
              sticky: true,
              className: 'municipality-tooltip' // CSS class defined in style.css
            });

            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            layer.on('click', () => {
              this.selectRegion(regionId);
            });

            // ãƒ›ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
            layer.on('mouseover', (e) => {
              if (this.currentRegion !== regionId) {
                e.target.setStyle({ weight: 4, fillOpacity: 0.4 });
              }
            });

            layer.on('mouseout', (e) => {
              if (this.currentRegion !== regionId) {
                e.target.setStyle({ weight: 2, fillOpacity: 0.2 });
              }
            });
          }
        });

        layer.addTo(this.map);
        regionGroups[regionId].push(layer);
        this.municipalityLayers.push({ layer, regionId, name });

      } catch (error) {
        console.warn(`Error adding layer for ${name}:`, error.message);
      }
    });

    // åŒ»ç™‚åœãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ
    Object.entries(regionGroups).forEach(([regionId, layers]) => {
      this.regionLayers[regionId] = L.featureGroup(layers);
    });

    // GeoJSONå–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã®ä»£æ›¿è¡¨ç¤º
    if (successful.length === 0) {
      console.warn('No municipality data loaded, using fallback');
      this.drawFallbackBoundaries();
    }
  }

  drawFallbackBoundaries() {
    // APIã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã®ä»£æ›¿ï¼ˆç°¡ç•¥åŒ–ãƒãƒªã‚´ãƒ³ï¼‰
    const fallbackCoords = {
      hiroshima: [[34.35, 132.35], [34.60, 132.40], [34.65, 132.60], [34.50, 132.65], [34.30, 132.55], [34.35, 132.35]],
      hiroshimaNishi: [[34.15, 132.10], [34.35, 132.15], [34.40, 132.35], [34.25, 132.40], [34.15, 132.10]],
      kure: [[34.08, 132.40], [34.32, 132.45], [34.35, 132.72], [34.08, 132.70], [34.08, 132.40]],
      hiroshimaChuo: [[34.25, 132.65], [34.52, 132.70], [34.50, 133.00], [34.20, 132.95], [34.25, 132.65]],
      bisan: [[34.32, 132.95], [34.62, 133.00], [34.55, 133.25], [34.30, 133.18], [34.32, 132.95]],
      fukuyamaFuchu: [[34.35, 133.20], [34.78, 133.25], [34.75, 133.55], [34.35, 133.50], [34.35, 133.20]],
      bihoku: [[34.60, 132.65], [35.00, 132.95], [35.00, 133.35], [34.65, 133.10], [34.60, 132.65]]
    };

    Object.entries(fallbackCoords).forEach(([regionId, coords]) => {
      const region = MEDICAL_DATA.regions[regionId];
      if (!region) return;

      const polygon = L.polygon(coords, {
        color: region.color,
        weight: 3,
        opacity: 0.8,
        fillColor: region.color,
        fillOpacity: 0.2
      });

      polygon.bindTooltip(`<strong>${region.name}åŒ»ç™‚åœ</strong><br>${region.municipalities.join('ã€')}`, {
        sticky: true,
        className: 'municipality-tooltip'
      });

      polygon.on('click', () => this.selectRegion(regionId));
      polygon.addTo(this.map);

      this.regionLayers[regionId] = L.featureGroup([polygon]);
      this.municipalityLayers.push({ layer: polygon, regionId, name: region.name });
    });
  }

  addHospitalMarkers() {
    Object.entries(MEDICAL_DATA.regions).forEach(([regionKey, region]) => {
      region.hospitals.forEach(hospital => {
        if (!hospital.lat || !hospital.lng) return;

        const minRadius = 6;
        const maxRadius = 18;
        const radius = minRadius + Math.min((hospital.beds - 100) / 700, 1) * (maxRadius - minRadius);

        let borderColor = '#ffffff';
        let borderWidth = 2;
        if (hospital.type === 'ç‰¹å®šæ©Ÿèƒ½' || hospital.type === 'åŸºå¹¹' || hospital.type === 'åœ°åŸŸåŒ»ç™‚æ”¯æ´') {
          borderColor = '#F59E0B'; // Amber for importance
          borderWidth = 3;
        }

        const marker = L.circleMarker([hospital.lat, hospital.lng], {
          radius: Math.max(radius, 6),
          fillColor: region.color,
          color: borderColor,
          weight: borderWidth,
          fillOpacity: 0.9,
          className: 'hospital-marker'
        });

        // Updated Popup Content (Clean HTML, no inline styles)
        // Note: Leaflet popups are stylable via CSS, but we keep some basic structure here.
        marker.bindPopup(`
          <div class="hospital-popup-content">
            <h3 style="color:${region.color}; border-bottom: 2px solid ${region.color}15;">${hospital.name}</h3>
            <div class="hospital-meta">
              <span class="type-badge">${hospital.type}</span>
              <span class="beds-display">
                <span class="count" style="color:${region.color}">${hospital.beds}</span>
                <span class="unit">åºŠ</span>
              </span>
            </div>
            <div class="address-row">ğŸ“ ${hospital.address}</div>
            ${hospital.url ? `<a href="${hospital.url}" target="_blank" class="website-link">ğŸ”— å…¬å¼ã‚µã‚¤ãƒˆã¸</a>` : ''}
          </div>
          <style>
            /* Scoped internal styles for popup content uniqueness if needed, but mostly relying on global style.css */
            .hospital-popup-content h3 { margin: 0 0 10px; font-size: 14px; padding-bottom: 4px; }
            .hospital-meta { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
            .type-badge { background: #f1f5f9; padding: 2px 8px; border-radius: 4px; font-size: 11px; color: #475569; }
            .beds-display .count { font-size: 18px; font-weight: 700; margin-right: 2px; }
            .beds-display .unit { font-size: 11px; color: #64748b; }
            .address-row { font-size: 11px; color: #64748b; margin-bottom: 8px; }
            .website-link { font-size: 11px; font-weight: 600; text-decoration: none; }
            .website-link:hover { text-decoration: underline; }
          </style>
        `, { maxWidth: 260 });

        marker.bindTooltip(`${hospital.name}<br>${hospital.beds}åºŠ`, { direction: 'top', className: 'hospital-tooltip' });
        marker.addTo(this.map);
        this.markers.push({ marker, regionKey, hospital });
      });
    });
  }

  selectRegion(regionId) {
    const region = MEDICAL_DATA.regions[regionId];
    if (!region) return;

    // å…¨ãƒãƒªã‚´ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
    this.municipalityLayers.forEach(({ layer, regionId: rId }) => {
      if (rId === regionId) {
        layer.setStyle({ weight: 3, fillOpacity: 0.5 });
        if (layer.bringToFront) layer.bringToFront();
      } else {
        layer.setStyle({ weight: 1, fillOpacity: 0.1 });
      }
    });

    // é¸æŠåŒ»ç™‚åœã«ã‚ºãƒ¼ãƒ 
    if (this.regionLayers[regionId]) {
      const bounds = this.regionLayers[regionId].getBounds();
      this.map.fitBounds(bounds, { padding: [50, 50], maxZoom: 11, animate: true });
    }

    // ãƒãƒ¼ã‚«ãƒ¼ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    this.markers.forEach(({ marker, regionKey }) => {
      if (regionKey === regionId) {
        marker.setStyle({ fillOpacity: 1, opacity: 1 });
        marker.bringToFront();
      } else {
        marker.setStyle({ fillOpacity: 0.3, opacity: 0.4 });
      }
    });

    this.currentRegion = regionId;
    this.updateSidePanel(regionId);

    if (window.app && window.app.updateChartForRegion) {
      window.app.updateChartForRegion(regionId);
    }
  }

  filterMarkers(level) {
    this.markers.forEach(({ marker, hospital }) => {
      const isMatch = (level === 'all') || (hospital.emergencyLevel === Number(level));

      if (isMatch) {
        if (!this.map.hasLayer(marker)) {
          marker.addTo(this.map);
        }
        if (this.currentRegion) {
          const markerObj = this.markers.find(m => m.marker === marker);
          if (markerObj && markerObj.regionKey === this.currentRegion) {
            marker.setStyle({ fillOpacity: 1, opacity: 1 });
          } else {
            marker.setStyle({ fillOpacity: 0.3, opacity: 0.4 });
          }
        } else {
          marker.setStyle({ fillOpacity: 0.9, opacity: 1 });
        }
      } else {
        if (this.map.hasLayer(marker)) {
          marker.removeFrom(this.map);
        }
      }
    });
  }

  updateSidePanel(regionId) {
    const container = document.getElementById('all-regions-content');
    if (!container) return;

    if (!regionId) {
      container.innerHTML = this.renderAllRegionsList();
    } else {
      container.innerHTML = this.renderSelectedRegion(regionId);
    }
  }

  renderAllRegionsList() {
    let html = '<div style="font-size:0.9rem;color:var(--text-muted);margin-bottom:1rem;text-align:center;">åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’è¡¨ç¤º</div>';

    Object.entries(MEDICAL_DATA.regions).forEach(([id, region]) => {
      const popChange = ((region.population[2040] - region.population[2020]) / region.population[2020] * 100).toFixed(1);

      // Using new CSS classes for cards
      html += `
        <div class="card" onclick="window.hiroshimaMap && window.hiroshimaMap.selectRegion('${id}')" 
             style="cursor:pointer; border-left: 4px solid ${region.color}; transition: all 0.2s; margin-bottom: 1rem;">
          <div class="card-body" style="padding: 1rem;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-weight:700;font-size:1.1rem;color:var(--text-primary);">${region.name}åŒ»ç™‚åœ</span>
              </div>
              <span style="font-size:1.2rem;font-weight:700;color:${region.color};">${region.beds.total.toLocaleString()}<span style="font-size:0.8rem;color:var(--text-muted);font-weight:400;">åºŠ</span></span>
            </div>
            
            <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.75rem;line-height:1.4;">
              ${region.municipalities.join('ã€')}
            </div>

            <div style="display:flex; justify-content: space-between; font-size:0.8rem; background:var(--bg-muted); padding: 0.5rem; border-radius: 4px;">
              <span>äººå£æ¨ç§»</span>
              <span>
                <strong>${(region.population[2020] / 10000).toFixed(1)}ä¸‡</strong>
                <span style="color:var(--text-muted);">â†’</span>
                <strong>${(region.population[2040] / 10000).toFixed(1)}ä¸‡</strong>
                <span style="color:var(--danger);font-weight:600;margin-left:4px;">(${popChange}%)</span>
              </span>
            </div>
            
            <!-- Added Arrival Time -->
             <div style="display:flex; justify-content: space-between; font-size:0.8rem; background:var(--bg-muted); padding: 0.5rem; border-radius: 4px; margin-top: 4px;">
              <span>å¹³å‡ç¾å ´åˆ°ç€æ™‚é–“</span>
              <span style="font-weight:700;">${region.avgArrivalTime || '-'} <span style="font-size:0.7rem;font-weight:400;">åˆ†</span></span>
            </div>
          </div>
        </div>
      `;
    });

    return html;
  }

  renderSelectedRegion(regionId) {
    const region = MEDICAL_DATA.regions[regionId];
    if (!region) return '';

    const popChange = ((region.population[2040] - region.population[2020]) / region.population[2020] * 100).toFixed(1);
    const sortedHospitals = [...region.hospitals].sort((a, b) => b.beds - a.beds);

    let html = `
      <div style="margin-bottom:1rem;">
        <button class="btn btn-secondary" onclick="window.hiroshimaMap && window.hiroshimaMap.resetView()">
          â† ä¸€è¦§ã«æˆ»ã‚‹
        </button>
      </div>
      
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid var(--border-color);">
        <span style="width:20px;height:20px;border-radius:4px;background:${region.color};"></span>
        <h2 style="margin:0;font-size:1.5rem;font-weight:800;color:var(--text-primary);">${region.name}åŒ»ç™‚åœ</h2>
      </div>
      
      <!-- Stats Grid -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:1.5rem;">
        <div class="stat-card">
          <div class="stat-value" style="color:${region.color}">${region.beds.total.toLocaleString()}</div>
          <div class="stat-label">ç·ç—…åºŠæ•°</div>
        </div>
        <div class="stat-card">
           <div class="stat-value" style="color:${region.avgTransportTime < 45 ? 'var(--secondary)' : 'var(--danger)'}">
             ${region.avgTransportTime}<span style="font-size:1rem;">åˆ†</span>
           </div>
           <div class="stat-label">å¹³å‡æ¬é€æ™‚é–“</div>
        </div>
      </div>

      <!-- Population -->
      <div class="card" style="margin-bottom:1.5rem;">
        <div class="card-body" style="padding:1rem;">
          <h4 style="font-size:0.9rem;margin-bottom:0.5rem;">äººå£æ¨ç§»äºˆæ¸¬</h4>
          <div style="display:flex;justify-content:space-between;align-items:flex-end;">
            <div>
              <div style="font-size:0.8rem;color:var(--text-muted);">2020å¹´: ${(region.population[2020] / 10000).toFixed(1)}ä¸‡äºº</div>
              <div style="font-size:0.8rem;color:var(--text-muted);">2040å¹´: ${(region.population[2040] / 10000).toFixed(1)}ä¸‡äºº</div>
            </div>
            <div style="font-size:1.1rem;font-weight:700;color:var(--danger);">${popChange}%</div>
          </div>
        </div>
      </div>
      
      <!-- Beds Graph -->
      <div style="margin-bottom:1.5rem;">
        <div style="font-size:0.9rem;font-weight:600;color:var(--text-secondary);margin-bottom:0.5rem;">ç—…åºŠæ©Ÿèƒ½æ§‹æˆ</div>
        <div style="display:flex;height:12px;border-radius:6px;overflow:hidden;background:var(--bg-muted);">
          <div style="width:${(region.beds.highAcute / region.beds.total * 100).toFixed(0)}%;background:var(--danger);" title="é«˜åº¦æ€¥æ€§æœŸ"></div>
          <div style="width:${(region.beds.acute / region.beds.total * 100).toFixed(0)}%;background:var(--accent);" title="æ€¥æ€§æœŸ"></div>
          <div style="width:${(region.beds.recovery / region.beds.total * 100).toFixed(0)}%;background:var(--secondary);" title="å›å¾©æœŸ"></div>
          <div style="width:${(region.beds.chronic / region.beds.total * 100).toFixed(0)}%;background:var(--primary);" title="æ…¢æ€§æœŸ"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.7rem;color:var(--text-muted);margin-top:4px;">
           <span>é«˜åº¦: ${region.beds.highAcute}</span>
           <span>æ…¢æ€§: ${region.beds.chronic}</span>
        </div>
      </div>
      
      <!-- Hospital List -->
      <div>
        <div style="font-size:0.9rem;font-weight:700;color:var(--text-primary);margin-bottom:0.75rem;">ä¸»è¦ç—…é™¢ (${region.hospitals.length}ä»¶)</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
        ${sortedHospitals.map((h, i) => `
          <div class="hospital-item" 
               onclick="window.hiroshimaMap && window.hiroshimaMap.focusHospital('${h.name}')"
               style="display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid var(--border-color);border-radius:8px;background:white;cursor:pointer;transition:all 0.2s;">
            <div>
              <div style="font-weight:700;font-size:0.95rem;color:var(--primary);">
                ${h.name} <span style="font-size:0.8em; opacity:0.7;">ğŸ”</span>
              </div>
              <div style="display:flex;gap:6px;margin-top:4px;align-items:center;">
                <span class="type-badge">${h.type}</span>
                ${h.url ? `<a href="${h.url}" target="_blank" onclick="event.stopPropagation()" style="font-size:0.75rem;color:var(--secondary);text-decoration:none;border-bottom:1px solid var(--secondary);">ğŸ”— å…¬å¼</a>` : ''}
              </div>
            </div>
            <div style="text-align:right;">
              <div style="font-weight:700;color:${region.color};">${h.beds}</div>
              <div style="font-size:0.7rem;color:var(--text-muted);">åºŠ</div>
            </div>
          </div>
        `).join('')}
        </div>
      </div>
    `;

    return html;
  }

  addLegend() {
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = () => {
      const div = L.DomUtil.create('div');
      // Using class defined in style.css or generic light styles
      div.className = 'map-legend-container';
      div.style.cssText = 'background:white;padding:12px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);font-size:11px;color:#333;border:1px solid #e2e8f0;';
      div.innerHTML = `
        <div style="font-weight:700;margin-bottom:8px;">ç—…åºŠæ•° / æ©Ÿèƒ½</div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <div style="width:12px;height:12px;border-radius:50%;background:#2563EB;opacity:0.9;"></div>
          <span>~200åºŠ</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <div style="width:18px;height:18px;border-radius:50%;background:#2563EB;opacity:0.9;"></div>
          <span>~500åºŠ</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <div style="width:24px;height:24px;border-radius:50%;background:#2563EB;opacity:0.9;"></div>
          <span>700åºŠ~</span>
        </div>
        <div style="border-top:1px solid #f1f5f9;padding-top:6px;display:flex;align-items:center;gap:6px;">
          <div style="width:14px;height:14px;border-radius:50%;background:#2563EB;border:2px solid #F59E0B;"></div>
          <span>ç‰¹å®šãƒ»åŸºå¹¹</span>
        </div>
      `;
      return div;
    };
    legend.addTo(this.map);
  }

  updateForScenario(scenarioId) {
    if (!scenarioId || scenarioId === 'current') {
      this.resetView();
      return;
    }

    // Reset styles first
    this.municipalityLayers.forEach(({ layer, regionId }) => {
      let targetRegionId = regionId;
      let targetColor = MEDICAL_DATA.regions[regionId].color;

      // ã‚·ãƒŠãƒªã‚ªã«å¿œã˜ãŸè‰²ã¨çµ±åˆãƒ­ã‚¸ãƒƒã‚¯
      if (scenarioId === 'scenario1') {
        // åºƒå³¶è¥¿ -> åºƒå³¶ã«çµ±åˆ
        if (regionId === 'hiroshimaNishi') {
          targetRegionId = 'hiroshima';
          targetColor = MEDICAL_DATA.regions['hiroshima'].color;
        }
      } else if (scenarioId === 'scenario2') {
        // åºƒå³¶è¥¿ -> åºƒå³¶ã€å‚™åŒ— -> åºƒå³¶ä¸­å¤®ã«çµ±åˆ
        if (regionId === 'hiroshimaNishi') {
          targetRegionId = 'hiroshima';
          targetColor = MEDICAL_DATA.regions['hiroshima'].color;
        } else if (regionId === 'bihoku') {
          targetRegionId = 'hiroshimaChuo';
          targetColor = MEDICAL_DATA.regions['hiroshimaChuo'].color;
        }
      }

      layer.setStyle({
        fillColor: targetColor,
        color: targetColor,
        weight: 1, // Merge visual look
        fillOpacity: 0.3
      });
    });

    // Reset view to center but don't reset data logic
    this.map.setView(this.center, this.defaultZoom, { animate: true });
    this.currentRegion = null;
    this.updateSidePanel(null);
  }

  focusHospital(hospitalName) {
    const target = this.markers.find(m => m.hospital.name === hospitalName);
    if (target) {
      this.map.flyTo(target.marker.getLatLng(), 14, { animate: true, duration: 1.5 });
      target.marker.openPopup();

      // Highlight marker temporarily
      const originalRadius = target.marker.options.radius;
      // Pulse effect (simple)
      let count = 0;
      const pulseInfo = setInterval(() => {
        if (count > 5) {
          clearInterval(pulseInfo);
          target.marker.setRadius(originalRadius);
          return;
        }
        target.marker.setRadius(originalRadius + (count % 2 === 0 ? 5 : 0));
        count++;
      }, 300);
    }
  }



  resetView() {
    this.municipalityLayers.forEach(({ layer, regionId }) => {
      const region = MEDICAL_DATA.regions[regionId];
      if (region) {
        layer.setStyle({
          color: region.color,
          fillColor: region.color,
          weight: 2,
          fillOpacity: 0.2
        });
      }
    });

    this.markers.forEach(({ marker }) => {
      marker.setStyle({ fillOpacity: 0.9, opacity: 1 });
    });

    this.map.setView(this.center, this.defaultZoom, { animate: true });
    this.currentRegion = null;
    this.updateSidePanel(null);

    // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ç”¨ã®å‘¼ã³å‡ºã—
    if (window.app && window.app.renderChart) {
      window.app.renderChart();
    }
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å…¬é–‹
window.HiroshimaMap = HiroshimaMap;
